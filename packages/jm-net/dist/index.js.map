{"version":3,"file":"index.js","sources":["../lib/heartbeat.js","../lib/ws.js","../lib/index.js"],"sourcesContent":["const event = require('jm-event')\n\nconst PingTimeout = 30000 // 默认心跳时间 30 秒\nconst PongTimeout = 5000 // 默认响应超时时间 5 秒\n\nclass HeartBeat {\n  constructor (opts = {}) {\n    event.enableEvent(this)\n\n    const { pingTimeout = PingTimeout, pongTimeout = PongTimeout } = opts\n\n    this.pingTimeout = pingTimeout\n    this.pongTimeout = pongTimeout\n  }\n\n  reset () {\n    this.stop()\n    this.start()\n    return this\n  }\n\n  start () {\n    const { pingTimeout, pongTimeout } = this\n    this.pingTimer = setTimeout(() => {\n      if (this.emit('heartBeat')) {\n        this.pongTimer = setTimeout(() => {\n          this.emit('heartDead')\n        }, pongTimeout)\n      } else {\n        console.warn('heartBeat event was not be correctly handled. heart beat is disabled')\n      }\n    }, pingTimeout)\n    return this\n  }\n\n  stop () {\n    this.pingTimer && clearTimeout(this.pingTimer)\n    this.pongTimer && clearTimeout(this.pongTimer)\n    return this\n  }\n}\n\nHeartBeat.PingTimeout = PingTimeout\nHeartBeat.PongTimeout = PongTimeout\n\nmodule.exports = HeartBeat\n","const event = require('jm-event')\nconst HeartBeat = require('./heartbeat')\n\nconst PingFailedCode = 4999 // 心跳失败后，关闭 code, 4000 至 4999 之间\nconst MaxReconnectAttempts = 0 // 默认重试次数0 表示无限制\nconst ReconnectTimeout = 3000 // 默认自动重连延时 3 秒\n\nclass WebSocket {\n  constructor (opts = {}) {\n    event.enableEvent(this)\n\n    const { Adapter, reconnect = true, reconnectTimeout = ReconnectTimeout, reconnectAttempts = MaxReconnectAttempts, pingFailedCode = PingFailedCode } = opts\n\n    if (!Adapter) throw new Error('invalid Adapter')\n    this.Adapter = Adapter\n\n    this.pingFailedCode = pingFailedCode\n\n    this.reconnect = reconnect\n    this.reconnectTimeout = reconnectTimeout\n    this.maxReconnectAttempts = reconnectAttempts\n\n    this.reconnectAttempts = 0\n\n    this._reconnectTimer = null\n\n    this.uri = null\n    this.ws = null\n    this.connecting = null // or a promise instance\n\n    const heart = new HeartBeat(opts)\n    this.heart = heart\n    heart\n      .on('heartBeat', () => {\n        return this.emit('heartBeat')\n      })\n      .on('heartDead', () => {\n        if (this.emit('heartDead')) return\n        this.close(this.pingFailedCode, 'heartbeat timeout')\n      })\n  }\n\n  get ready () {\n    return !!this.ws\n  }\n\n  onReady () {\n    if (this.ws) return\n    return this.connect()\n  }\n\n  connect (uri) {\n    uri && (this.uri = uri)\n    if (!this.connecting) {\n      this.connecting = this._connect()\n    }\n    return this.connecting\n  }\n\n  async send () {\n    await this.onReady()\n    try {\n      this.ws.send(...arguments)\n      this.heart.reset()\n    } catch (e) {\n      throw e\n    }\n  }\n\n  close () {\n    this._stopReconnect()\n    if (!this.ws) return\n    this.ws.close(...arguments)\n    this.ws = null\n    this.connecting = null\n  }\n\n  async _connect () {\n    const { uri } = this\n\n    if (!uri) throw new Error('invalid uri')\n\n    if (this.ws) return\n\n    this.emit('connect')\n\n    return new Promise((resolve, reject) => {\n      let ws = null\n      try {\n        ws = new this.Adapter(uri)\n      } catch (e) {\n        return reject(e)\n      }\n\n      ws\n        .on('message', opts => {\n          this.heart.reset()\n          this.emit('message', opts)\n        })\n        .on('open', opts => {\n          this.emit('open', opts)\n          this.ws = ws\n          this.connecting = null\n          this.heart.reset()\n          this._stopReconnect()\n          resolve()\n        })\n        .on('error', e => {\n          this.emit('error', e)\n          reject(e)\n        })\n        .on('close', opts => {\n          this.emit('close', opts)\n          this.heart.stop()\n          this.ws = null\n          this.connecting = null\n\n          const { wasClean = true, code } = opts\n          if (wasClean && code !== this.pingFailedCode) return\n          if (this.reconnect) {\n            this._reconnect()\n          }\n        })\n    })\n  }\n\n  _reconnect () {\n    if (this.maxReconnectAttempts && this.reconnectAttempts >= this.maxReconnectAttempts) {\n      this.emit('connectFail')\n      this._stopReconnect()\n      return\n    }\n    this.reconnectAttempts++\n    this.emit('reconnect')\n    this._reconnectTimer = setTimeout(() => {\n      this._reconnectTimer = null\n      this\n        .connect()\n        .catch(() => {})\n    }, this.reconnectTimeout)\n  }\n\n  _stopReconnect () {\n    if (this._reconnectTimer) {\n      clearTimeout(this._reconnectTimer)\n      this._reconnectTimer = null\n    }\n    this.reconnectAttempts = 0\n  }\n}\n\nWebSocket.MaxReconnectAttempts = MaxReconnectAttempts\nWebSocket.ReconnectTimeout = ReconnectTimeout\n\nWebSocket.PingFailedCode = PingFailedCode\n\nmodule.exports = WebSocket\n","const HeartBeat = require('./heartbeat')\nconst WebSocket = require('./ws')\n\nconst $ = {\n  HeartBeat,\n  WebSocket\n}\n\nmodule.exports = $\n"],"names":["PingTimeout","PongTimeout","HeartBeat","opts","event","enableEvent","pingTimeout","pongTimeout","stop","start","pingTimer","setTimeout","emit","pongTimer","console","warn","clearTimeout","value","then","Promise","PingFailedCode","MaxReconnectAttempts","ReconnectTimeout","WebSocket","Adapter","reconnect","reconnectTimeout","reconnectAttempts","pingFailedCode","Error","maxReconnectAttempts","_reconnectTimer","uri","ws","connecting","heart","on","close","connect","_connect","arguments","onReady","send","reset","e","_stopReconnect","resolve","reject","wasClean","code","_reconnect","$"],"mappings":"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"}
{"version":3,"file":"jm-net.js","sources":["../lib/heartbeat.js","../lib/ws.js","../lib/index.js"],"sourcesContent":["const event = require('jm-event')\n\nconst PingTimeout = 60000 // 默认心跳时间 60 秒\nconst PongTimeout = 10000 // 默认响应超时时间 10 秒\n\nclass HeartBeat {\n  constructor (opts = {}) {\n    event.enableEvent(this)\n\n    const {pingTimeout = PingTimeout, pongTimeout = PongTimeout} = opts\n\n    this.pingTimeout = pingTimeout\n    this.pongTimeout = pongTimeout\n  }\n\n  reset () {\n    this.stop()\n    this.start()\n    return this\n  }\n\n  start () {\n    const {pingTimeout, pongTimeout} = this\n    this.pingTimer = setTimeout(() => {\n      if (this.emit('heartBeat')) {\n        this.pongTimer = setTimeout(() => {\n          this.emit('heartDead')\n        }, pongTimeout)\n      }\n    }, pingTimeout)\n    return this\n  }\n\n  stop () {\n    this.pingTimer && clearTimeout(this.pingTimer)\n    this.pongTimer && clearTimeout(this.pongTimer)\n    return this\n  }\n}\n\nHeartBeat.PingTimeout = PingTimeout\nHeartBeat.PongTimeout = PongTimeout\n\nmodule.exports = HeartBeat\n","const event = require('jm-event')\nconst HeartBeat = require('./heartbeat')\n\nconst PingFailedCode = 4999 // 心跳失败后，关闭 code, 4000 至 4999 之间\nconst MaxReconnectAttempts = 0 // 默认重试次数0 表示无限制\nconst ReconnectTimeout = 3000 // 默认自动重连延时 3 秒\n\nclass WebSocket {\n  constructor (opts = {}) {\n    event.enableEvent(this)\n\n    const {Adapter, timeout = 0, reconnect = true, reconnectTimeout = ReconnectTimeout, reconnectAttempts = MaxReconnectAttempts, pingFailedCode = PingFailedCode} = opts\n\n    if (!Adapter) throw new Error('invalid Adapter')\n    this.Adapter = Adapter\n\n    this.pingFailedCode = pingFailedCode\n\n    this.reconnect = reconnect\n    this.reconnectTimeout = reconnectTimeout\n    this.maxReconnectAttempts = reconnectAttempts\n\n    this.reconnectAttempts = 0\n\n    this._reconnectTimer = null\n\n    this.uri = null\n    this.ws = null\n    this.connecting = null // or a promise instance\n\n    const heart = new HeartBeat(opts)\n    this.heart = heart\n    heart\n      .on('heartBeat', () => {\n        return this.emit('heartBeat')\n      })\n      .on('heartDead', () => {\n        if (this.emit('heartDead')) return\n        this.close(this.pingFailedCode, 'heartbeat timeout')\n      })\n  }\n\n  get ready () {\n    return this.ws ? true : false\n  }\n\n  onReady () {\n    if (this.ws) return\n    return this.connect()\n  }\n\n  connect (uri) {\n    uri && (this.uri = uri)\n    if (!this.connecting) {\n      this.connecting = this._connect()\n    }\n    return this.connecting\n  }\n\n  async send () {\n    await this.onReady()\n    try {\n      this.ws.send(...arguments)\n      this.heart.reset()\n    } catch (e) {\n      throw e\n    }\n  }\n\n  close () {\n    this._stopReconnect()\n    if (!this.ws) return\n    this.ws.close(...arguments)\n    this.ws = null\n    this.connecting = null\n  }\n\n  async _connect () {\n    const {uri} = this\n\n    if (!uri) throw new Error('invalid uri')\n\n    if (this.ws) return\n\n    this.emit('connect')\n\n    return new Promise((resolve, reject) => {\n\n      let ws = null\n      try {\n        ws = new this.Adapter(uri)\n      } catch (e) {\n        return reject(e)\n      }\n\n      ws\n        .on('message', opts => {\n          this.heart.reset()\n          this.emit('message', opts)\n        })\n        .on('open', opts => {\n          this.emit('open', opts)\n          this.ws = ws\n          this.connecting = null\n          this.heart.reset()\n          this._stopReconnect()\n          resolve()\n        })\n        .on('error', e => {\n          this.emit('error', e)\n          reject(e)\n        })\n        .on('close', opts => {\n          this.emit('close', opts)\n          this.heart.stop()\n          this.ws = null\n          this.connecting = null\n\n          const {wasClean = true, code} = opts\n          if (wasClean && code !== this.pingFailedCode) return\n          if (this.reconnect) {\n            this._reconnect()\n          }\n        })\n    })\n  }\n\n  _reconnect () {\n    if (this.maxReconnectAttempts && this.reconnectAttempts >= this.maxReconnectAttempts) {\n      this.emit('connectFail')\n      this._stopReconnect()\n      return\n    }\n    this.reconnectAttempts++\n    this.emit('reconnect')\n    this._reconnectTimer = setTimeout(() => {\n      this._reconnectTimer = null\n      this\n        .connect()\n        .catch(() => {})\n    }, this.reconnectTimeout)\n  }\n\n  _stopReconnect () {\n    if (this._reconnectTimer) {\n      clearTimeout(this._reconnectTimer)\n      this._reconnectTimer = null\n    }\n    this.reconnectAttempts = 0\n  }\n\n}\n\nWebSocket.MaxReconnectAttempts = MaxReconnectAttempts\nWebSocket.ReconnectTimeout = ReconnectTimeout\n\nWebSocket.PingFailedCode = PingFailedCode\n\nmodule.exports = WebSocket\n","const HeartBeat = require('./heartbeat')\nconst WebSocket = require('./ws')\n\nconst $ = {\n  HeartBeat,\n  WebSocket\n}\n\nmodule.exports = $\n"],"names":["PingTimeout","PongTimeout","HeartBeat","opts","event","enableEvent","pingTimeout","pongTimeout","stop","start","pingTimer","setTimeout","emit","pongTimer","clearTimeout","i","PingFailedCode","MaxReconnectAttempts","ReconnectTimeout","WebSocket","Adapter","timeout","reconnect","reconnectTimeout","reconnectAttempts","pingFailedCode","Error","maxReconnectAttempts","_reconnectTimer","uri","ws","connecting","heart","on","close","connect","_connect","onReady","send","reset","e","_stopReconnect","arguments","Promise","resolve","reject","wasClean","code","_reconnect","catch","$"],"mappings":"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"}